(ns nhss.standard-level-data
  (:require [nhss.levels    :as levels]
            [clojure.string :as string]
            [nhss.util      :refer [trace! print-cells!]]))

(defn level->cells [level]
  (into [] (map (comp (partial apply vector) seq) level)))

(defn cells->floor [floor-character cells]
  (mapv (fn [cells]
          (mapv (fn [cell]
                  (cond (or (= (:boulder levels/features) cell)
                            (= (:hole levels/features) cell))
                        floor-character

                        ((:wall levels/features) cell)
                        (:empty levels/features)

                        (= (:player levels/features) cell)
                        (:down-stair levels/features)

                        :default
                        cell))
                cells))
        cells))

(defn title->id [title]
  (keyword (last (string/split title #" "))))

(defn position= [level position position-string]
  (= (levels/get-position-string level position) position-string))

(defn level->player-position [level]
  (let [height    (count (:cells level))
        width     (count (first (:cells level)))
        positions (->> (map (fn [y]
                              (map (fn [x]
                                     [x,y])
                                   (range width)))
                            (range height))
                       (apply concat)
                       sort)]
    (loop [[position & next-positions] positions]
      (if (position= level position (:player levels/features))
        position
        (recur next-positions)))))

(defn apply-diff [[x1 y1] [x2 y2]]
  [(+ x1 x2) (+ y1 y2)])

(defn potential-neighbors [node]
  (map (partial apply-diff node) [[-1 -1] [0 -1] [1 -1]
                                  [-1  0]        [1  0]
                                  [-1  1] [0  1] [1  1]]))

(defn floor? [floor node]
  (not= (:empty levels/features)
        (levels/get-cells-position-string floor node)))

(defn valid-position? [cells [x y :as position]]
  (and (every? pos? position)
       (< x (count (first cells)))
       (< y (count cells))))

(defn neighbors [floor node]
  {:pre [(floor? floor node)]}
  (filterv (partial floor? floor) (filter (partial valid-position? floor) (potential-neighbors node))))

(defn first-node [floor]
  (let [positions (for [y (range (count floor)) x (range (count (first floor)))] [x y])]
    (first (filter (partial floor? floor) positions))))

(defn floor->graph [floor]
  (loop [node-queue    #{(first-node floor)}
         visited-nodes #{}
         graph         {}]
    (if (empty? node-queue)
      graph
      (let [current-node   (first node-queue)
            next-nodes     (apply hash-set (next node-queue))
            node-neighbors (neighbors floor (first node-queue))]
        (recur (into next-nodes (filter (complement visited-nodes) node-neighbors))
               (conj visited-nodes current-node)
               (assoc graph current-node node-neighbors))))))

(defn cells->floor-character [cells]
  (some (:space levels/features) (flatten cells)))

(defn deflevel [title info & level]
  (let [cells           (level->cells level)
        floor-character (cells->floor-character cells)
        floor           (cells->floor floor-character cells)
        floor-graph     (floor->graph floor)
        level           {:id              (title->id title)
                         :title           title
                         :info            info
                         :cells           cells
                         :floor           floor
                         :floor-graph     floor-graph}]
    (assoc level :player-position (level->player-position level))))

(def levels
  {(keyword "NetHack Sokoban 1a")
   (deflevel
     "NetHack Sokoban 1a"
     ""
     "┌─┬────┐ ┌────┐"
     "│<│@···└─┘····│"
     "│^├┐·00····0··│"
     "│^││··00│·0·0·│"
     "│^││····│·····│"
     "│^│└───┬┘0────┤"
     "│^│    │······│"
     "│^└────┘······│"
     "│··^^^^0000···│"
     "│??┌───┐······│"
     "└──┘   └──────┘")

   (keyword "NetHack Sokoban 1b")
   (deflevel
     "NetHack Sokoban 1b"
     ""
     "┌────┐  ┌───┐ "
     "│····│  │···│ "
     "│·0··└──┘·0·│ "
     "│·0······0··│ "
     "│··┌─┐@┌─┐0·│ "
     "├──┴─┴─┼─┘·─┴┐"
     "│··^^^<│·····│"
     "│··┌───┤0····│"
     "└┐^│   │·0···│"
     " │^└───┘·0···│"
     " │··^^^^0·0··│"
     " │??┌────────┘"
     " └──┘         ")

   (keyword "NetHack Sokoban 2a")
   (deflevel
     "NetHack Sokoban 2a"
     ""
     " ┌──┐          ┌─────────┐"
     "┌┘·@└──────┐   │·········│"
     "│··········│   │·········│"
     "│·0┌───┐0─·│   │·········│"
     "│··│···│·0·│   │····<····│"
     "│·0·0····0─┤   │·········│"
     "│·0··0··│··│   │·········│"
     "│·────0·└┐·│   │·········│"
     "│··0···0·│·└┐  │·········│"
     "│·──┬0─···0·└──┴────────+┤"
     "│···│··0─·0·^^^^^^^^^^^^·│"
     "│··0······┌──────────────┘"
     "└───┐··│··│               "
     "    └──┴──┘               ")

   (keyword "NetHack Sokoban 2b")
   (deflevel
     "NetHack Sokoban 2b"
     ""
     "┌────┬────┐       ┌─────────┐"
     "│····│····└─┐     │·········│"
     "│··00│00···@│     │·········│"
     "│·····0···┌─┘     │·········│"
     "│····│····│       │····<····│"
     "├─·──┼────┴┐      │·········│"
     "│··0·│·····│      │·········│"
     "│·00·│0·0·0│      │·········│"
     "│··0·····0·│      │·········│"
     "│·000│0··0·└───────────────+┤"
     "│····│··0·0·^^^^^^^^^^^^^^^·│"
     "└────┴──────────────────────┘")

   (keyword "NetHack Sokoban 3a")
   (deflevel
     "NetHack Sokoban 3a"
     ""
     "  ┌─┬────┐          "
     "┌─┘·│····│          "
     "│···0····├─┬───────┐"
     "│·─·00─00│·│·······│"
     "│·00─······│·······│"
     "│·─··0·│···│·······│"
     "│····─0├─0─┤···<···│"
     "│··00··0···│·······│"
     "│·──···─···│·······│"
     "│····─0┬───┤·······│"
     "└─┐··0·└───┴──────+┤"
     "  │··0@^^^^^^^^^^^·│"
     "  └────────────────┘")

   (keyword "NetHack Sokoban 3b")
   (deflevel
     "NetHack Sokoban 3b"
     ""
     "┌────────┬───┬─────┐"
     "│········│···│·····│"
     "│·00··─00│·─·│·····│"
     "│··│·0·0·│00·│·····│"
     "│─·│··─··│·─·│··<··│"
     "│···│─·······│·····│"
     "│···│·0·─···┌┤·····│"
     "│·0·│0·│···┌┘│·····│"
     "├─0·│··└───┴─┴────+┤"
     "│··0····^^^^^^^^^^·│"
     "│···│·@┌───────────┘"
     "└───┴──┘            ")

   (keyword "NetHack Sokoban 4a")
   (deflevel
     "NetHack Sokoban 4a"
     "With a Bag of Holding"
     "┌────────────────────────┐"
     "│@······^^^^^^^^^^^^^^^^·│"
     "│·······┌──────────────┐·│"
     "└┬─────·└────┐         │·│"
     " │···········│         │·│"
     " │·0·0·0·0·0·│         │·│"
     "┌┴──────·────┤         │·│"
     "│···0·0··0·0·│         │·│"
     "│···0········│         │·│"
     "└┬───·──────┬┘   ┌─────┤·│"
     " │··0·0·0···│  ┌─┤·····│·│"
     " │·····0····│  │·+·····│·│"
     " │·0·0···0·┌┘  ├─┤·····│·│"
     "┌┴─────·─┬─┘   │·+·····+·│"
     "│··0·····│     ├─┤·····├─┘"
     "│········│     │·+·····│  "
     "│···┌────┘     └─┤·····│  "
     "└───┘            └─────┘  ")

   (keyword "NetHack Sokoban 4b")
   (deflevel
     "NetHack Sokoban 4b"
     "With an Amulet of Reflection"
     "  ┌──────────────────────┐"
     "  │··^^^^^^^^^^^^^^^^^^··│"
     "  │··┌────────┬────────┐·│"
     "┌─┴┐·│    ┌───┤        │·│"
     "│··│0└┐  ┌┘···│        │·│"
     "│·····├──┤·0··│        │·│"
     "│·00··│··│··0·│        │·│"
     "└┐··00│···00·┌┘        │·│"
     " │0··0···│0··│   ┌─────┤·│"
     " │·00·│··│··0│ ┌─┤·····│·│"
     " │·0·0└──┤·0·│ │·+·····│·│"
     " │·······│··┌┘ ├─┤·····│·│"
     " └──┐·0··│·┌┘  │·+·····+·│"
     "    └┬─·─┘·│   ├─┤·····├─┘"
     "     │·0···│   │·+·····│  "
     "     │@·│··│   └─┤·····│  "
     "     └──┴──┘     └─────┘  ")

   (keyword "Evil Variant 2a")
   (deflevel
     "Evil Variant 2a"
     ""
     " ┌──┐          ┌─────────┐"
     "┌┘·@└──────┐   │·········│"
     "│··········│   │·········│"
     "│·0┌───┐0─·│   │·········│"
     "│··│···│·0·│   │····<····│"
     "│·0·0····0─┤   │·········│"
     "│·0··0··│··│   │·········│"
     "│·────0·└┐·│   │·········│"
     "│··0···0·│·└┐  │·········│"
     "│·──┐0─···0^└──┴────────+┤"
     "│···│··0─·^^^^^^^^^^^^^^·│"
     "│··0······┌──────────────┘"
     "└───┐··│··│               "
     "    └──┴──┘               ")

   (keyword "Evil Variant 2b")
   (deflevel
     "Evil Variant 2b"
     ""
     " ┌──┐          ┌─────────┐"
     "┌┘·@└──────┐   │·········│"
     "│··········│   │·········│"
     "│·0┌───┐0─·│   │·········│"
     "│··│···│·0·│   │····<····│"
     "│·0·0····0─┤   │·········│"
     "│·0··0··│··│   │·········│"
     "│·───00·└┐·│   │·········│"
     "│··0···0·│·└┐  │·········│"
     "│·──┐0─··0·^└──┴────────+┤"
     "│···│··0─·^^^^^^^^^^^^^^·│"
     "│··0······┌──────────────┘"
     "└───┐··│··│               "
     "    └──┴──┘               ")

   (keyword "NetHack Fourk - Boomerang Boulders")
   (deflevel
     "NetHack Fourk - Boomerang Boulders"
     ""
     "         ----    "
     " ---------..---  "
     " |.0.0....0...---"
     " |.......|0..0..|"
     "---------|....0.|"
     "|.^^^^^^<|...0..|"
     "|.^------|-.-----"
     "--^^^.0..|.0...| "
     " |??|0.@....00.| "
     " ---|....|.....| "
     "    ------------ ")

   (keyword "NetHack Fourk - Easy Peasey")
   (deflevel
     "NetHack Fourk - Easy Peasey"
     ""
     " ------   ----"
     " |....-----??|"
     " |...0^^^^^^.|"
     " |..0.------^|"
     " |.0..0..0.|^|"
     "--0....0...|^|"
     "|...0....0.|<|"
     "|.@..|.-------"
     "------.|...|  "
     " |.........|  "
     " --.0..|.0.|  "
     "  ---..|...|  "
     "    --------  ")

   (keyword "NetHack Fourk - First Things First")
   (deflevel
     "NetHack Fourk - First Things First"
     ""
     "---------------"
     "|.....|.....|<|"
     "|.@..0|.0.0.|^|"
     "|.....|0.0..|^|"
     "|.0..0......|^|"
     "|--.--|0..0.|^|"
     "|...0.|.....|^|"
     "|.....-------^|"
     "|.0.0....^^^^.|"
     "-----...----??|"
     "    -----  ----")

   (keyword "NetHack Fourk - Picking out the Seeds")
   (deflevel
     "NetHack Fourk - Picking out the Seeds"
     "Early versions of NetHack Fourk also had a partial version of Through the Cracks as a possibility here. For 4.3.0.2, the north rooms were added and it was moved to the third level of Sokoban (see below)."
     "   ---------   "
     " ---..|....--- "
     " |.0..|..0.0@| "
     "--...00...0.---"
     "|.....|..0..|<|"
     "|.0.0....0---^|"
     "|------^..|.^^|"
     "|...0.0^---.^.|"
     "--.....^^^^^^--"
     " |.0...0---??| "
     " ---......|--- "
     "   --------    ")

   (keyword "NetHack Fourk - Open the Door")
   (deflevel
     "NetHack Fourk - Open the Door"
     ""
     "       ----------- "
     "   -----.........| "
     "   |..0.....0.0..| "
     "----.|.|.0.-----.| "
     "|....-----.0..--0| "
     "|.......0.0......| "
     "|-^|.......--.--.| "
     "|-^|--------|.||.| "
     "|?.------...|.--.--"
     "|?..^^^^^.00+.0.@.|"
     "---------.<.|.....|"
     "        |...|------"
     "        -----      ")

   (keyword "NetHack Fourk - Fly on the Wall")
   (deflevel
     "NetHack Fourk - Fly on the Wall"
     ""
     "                     ---- "
     "   -------------------..| "
     "----........^^^^^^^^^^^^--"
     "|......--00.----------.^.|"
     "|.0.--..0..--        |..^|"
     "|0.0--00.0.|         --|^|"
     "|.00..0....--  --------|+|"
     "|......0.0.@|  |.........|"
     "--0----------  |.........|"
     " |..|          |....<....|"
     "--..-------    |.........|"
     "|.0.0.0...|    |.........|"
     "|.........|    -----------"
     "-----------               ")

   (keyword "NetHack Fourk - Boulder Halls of Zim")
   (deflevel
     "NetHack Fourk - Boulder Halls of Zim"
     ""
     "               -----------"
     "  ---------    |.........|"
     " --.......|    |.........|"
     " |..0.0.0.--   |.........|"
     " ---..---..|   |.........|"
     "   |..| |..|   |....<....|"
     "----.----.0|   |.........|"
     "|.0.0.0.|..|   |.........|"
     "|........00|   |.........|"
     "|.0.0.0.0..-------------+|"
     "--.....--..^^^^^^^^^^^^^.|"
     " --.0...------------------"
     "  ---.@...|               "
     "    -------               ")

   (keyword "NetHack Fourk - Two-Phase")
   (deflevel
     "NetHack Fourk - Two-Phase"
     ""
     " ----------                "
     " |........|                "
     " |........|                "
     " |...<....|------------    "
     " |........|..@..|.....-----"
     " |........|.0.0.+000.0....|"
     " |..----+-|0.0.0|....0..0.|"
     " |---..|.--.---.----.----.|"
     " |..^^.|^|....-..| |...0..|"
     " |.^|..|^|.....0.---......|"
     " --^|..0^|.0...-....0.....|"
     "  |^|....|.---...---.------"
     "  |^------.0..........|    "
     "  |..^^^^^.......------    "
     "  |..-------------         "
     "  ----                     ")

   (keyword "NetHack Fourk - Bring 'em On Down")
   (deflevel
     "NetHack Fourk - Bring 'em On Down"
     ""
     "---------------   -----------"
     "|.............|   |.........|"
     "|....0..|0..0.|   |.........|"
     "|.0..----.0.0.|   |.........|"
     "|---..........|   |....<....|"
     "|..0..0.|0.00.|   |.........|"
     "|.0.0...|.....|   |.........|"
     "|....0---------   |.........|"
     "|.0..0.0.|        |.........|"
     "|.0.0.0..------------------+|"
     "----..@..^^^^^^^^^^^^^^^^^^.|"
     "   --------------------------")

   (keyword "NetHack Fourk - Slot Machine")
   (deflevel
     "NetHack Fourk - Slot Machine"
     ""
     "--------------------"
     "|..|.....|.|.......|"
     "|.0|..|.0..|.......|"
     "|..|.0|..|.|.......|"
     "|.....|0.|.|...<...|"
     "--0|0.|..|.|.......|"
     " |.|..0.0|.|.......|"
     " |.|.0.....|.......|"
     " |.0...@.---------.|"
     " |..0..0.|       |.|"
     " --0.0------------+|"
     "  |...^^^^^^^^^^^^.|"
     "  ------------------")

   (keyword "NetHack Fourk - Through the Cracks")
   (deflevel
     "NetHack Fourk - Through the Cracks"
     ""
     " ---------------------"
     "--....||...........+.|"
     "|..00.||...........|^|"
     "|.0...||..<........|^|"
     "|.0..--|...........|^|"
     "---0-- |...........|^|"
     " |..---------------|^|"
     " |...0...0....0..0.|^|"
     " |..0...0.-..0..0..|^|"
     "--.---..---.--.0.@.|^|"
     "|.0--.0---.0--0-----^|"
     "|.............^^^^^^^|"
     "-------------------..|"
     "                  ----")

   (keyword "NetHack Fourk - Either Way, It's All Good")
   (deflevel
     "NetHack Fourk - Either Way, It's All Good"
     "The stairs are interchangeable."
     "           ----           "
     "    --------..--------    "
     "  ---...|.0......|...---  "
     "  |.0...|...0.|..|...0.|  "
     "  |.0.0.|..0---0.|.0.0.|  "
     " --.------..|....-----.-- "
     " |..^^^^^^^^------...0..| "
     "--.0-------^.|...|...00.--"
     "|<..0.0.|.0.^^.0.|.0.0..@|"
     "--.00...|...|.^-------0.--"
     " |..0...------^^^^^^^^..| "
     " --.-----....|..------.-- "
     "  |.0.0.|.0---0..|.0.0.|  "
     "  |.0...|..|.0...|...0.|  "
     "  ---...|......0.|...---  "
     "    --------..--------    "
     "           ----           ")

   (keyword "NetHack Fourk - Open at the Top")
   (deflevel
     "NetHack Fourk - Open at the Top"
     "Features a bag of holding."
     "------------------    ----"
     "|................------..|"
     "|................^^^^^^^.|"
     "|--.------------.-------^|"
     "|..0..|.....|....|     |^|"
     "|....0|0..0..0...|     |^|"
     "|.0..0.......-----     |^|"
     "|.....|.00.00|         |^|"
     "|....0--.....|         |^|"
     "-----.--------   ------|^|"
     " |....0....|   --|.....|^|"
     " |.00..0.0.|   |.+.....|^|"
     " |-.----...|   |-|.....|^|"
     " |..0...0.--   |.+.....+.|"
     " |.@...0..|    |-|.....|--"
     " |.....----    |.+.....|  "
     " -------       --|.....|  "
     "                 -------  ")

   (keyword "NetHack Fourk - Collecting Marbles")
   (deflevel
     "NetHack Fourk - Collecting Marbles"
     "Features an amulet of reflection"
     "  ------------------------"
     "  |..^^^^^^^^^^^^^^^^^^..|"
     "  |..-------------------.|"
     "----.--   ----         |.|"
     "|.0...-----..|         |.|"
     "|......0..00.|         |.|"
     "--.0.....|.0.|         |.|"
     " --....0.|...|         |.|"
     "  |0----.--.-|   ------|.|"
     " --.0.--..0..| --|.....|.|"
     " |...........| |.+.....|.|"
     " |0.0---.--.-| |-|.....|.|"
     " |...|.0..0..| |.+.....+.|"
     "--.---..0..0.| |-|.....|--"
     "|.0..0.0.0.0.| |.+.....|  "
     "|.@..|.......| --|.....|  "
     "--------------   -------  ")

   (keyword "NetHack Fourk - Ring 'em Around")
   (deflevel
     "NetHack Fourk - Ring 'em Around"
     "Features a ring of polymorph control."
     "----         -------------     "
     "|..|----------.....|.....------"
     "|.0|.........0..--0|0.0..0..0.|"
     "|.......0.----.....|...--.....|"
     "|..|..-----  |.0...0..--..0...|"
     "|.0----      ------|0..----..--"
     "|.....|            |.........| "
     "|....--      ------|0.....--.--"
     "|.0.--       |.|.|.|..0.0.|.^.|"
     "---.------- --+-+-+-----.---^--"
     "|.0..|....| |.......| |..| |^| "
     "|....|.@0.| |.......| |.0| |^| "
     "|...-----.| |.......| |..| |^| "
     "|..--   |.| |.......| ---- |^| "
     "|..|   --.| |.......|      |^--"
     "|.0-----..------+-----------^.|"
     "|0.......0.|   |.^^^^^^^^^^^..|"
     "|..-----...|   ----------------"
     "----   -----                   ")

   (keyword "NetHack Fourk - Jumpin' All Around")
   (deflevel
     "NetHack Fourk - Jumpin' All Around"
     "Features a ring of teleport control."
     "----                  -----------"
     "|..------------------ |.........|"
     "|..^^^^^^^^^^.......| |.0..0.0..|"
     "--^-------------+---| |..--.--.--"
     " |^|        |.......| |.--.....| "
     " |^| ------ |.......| |.0....0.| "
     " |^| |....| |.......| |....0...| "
     " |^| |0...| |.......| |..0..0..| "
     " |^| |.0..| |.......| |.------.| "
     " |^| |..0.| --+-+-+-- |0......0| "
     " |^| |0..0|  |.|.|.|  |...-+-..| "
     " |^| |.0..----------  |0..|.|.0| "
     " |^| |..0....@|  ---- |...---..| "
     " |^| |.0...--0----..| |0.......| "
     "--^---0-----......0.---.------.--"
     "|....0........|.0..0^^^^........|"
     "|....---......|..-------------..|"
     "------ -----------           ----")})
